<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEBUG - Int√©gration Client</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { border: 1px solid #ddd; padding: 20px; margin: 20px 0; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; }
        input[type="file"] { margin: 10px 0; }
        button { padding: 10px 20px; margin: 10px; }
        .status { padding: 10px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>üîß DEBUG - Test Upload Fichiers</h1>
    
    <div class="section">
        <h2>1. Test Upload CIN</h2>
        <label>CIN Recto:</label>
        <input type="file" id="cin_front" accept="image/*,.pdf">
        <div id="cin_front_status" class="status"></div>
        
        <label>CIN Verso:</label>
        <input type="file" id="cin_back" accept="image/*,.pdf">
        <div id="cin_back_status" class="status"></div>
    </div>

    <div class="section">
        <h2>2. Debug Info</h2>
        <div id="debug_info" class="debug">
            <p>Uploadez des fichiers pour voir les infos...</p>
        </div>
        <button onclick="showDebugInfo()">üîç V√©rifier uploadedFiles</button>
        <button onclick="testSubmit()">üöÄ Test Envoi (sans envoyer)</button>
    </div>

    <div class="section">
        <h2>3. Formulaire minimal</h2>
        <form id="testForm">
            <input type="text" name="nom" placeholder="Nom" value="Test">
            <input type="text" name="prenom" placeholder="Pr√©nom" value="Debug">
            <input type="email" name="email" placeholder="Email" value="test@debug.com">
            <input type="text" name="raison_sociale" placeholder="Soci√©t√©" value="Test SARL">
            <button type="submit">üì§ Test Envoi</button>
        </form>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            WEBHOOK_URL: 'https://n8n.srv910637.hstgr.cloud/webhook/client-onboarding',
            CABINET_NAME: 'AGENCE EFFICADS',
            GESTIONNAIRE_NOM: 'BENHLAL YAZID',
            GESTIONNAIRE_EMAIL: 'benhlalyazid@gmail.com'
        };

        const uploadedFiles = {};

        // Fonction de conversion base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                console.log('üîÑ Conversion base64 pour:', file.name);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    const result = {
                        content: base64,
                        mimeType: file.type,
                        extension: file.name.split('.').pop(),
                        size: file.size,
                        name: file.name
                    };
                    console.log('‚úÖ Conversion r√©ussie:', result.name, 'Taille base64:', base64.length);
                    resolve(result);
                };
                reader.onerror = error => {
                    console.error('‚ùå Erreur conversion:', error);
                    reject(error);
                };
            });
        }

        // Fonction d'upload
        async function handleFileUpload(input, statusDiv) {
            const file = input.files[0];
            console.log('üìÅ Fichier s√©lectionn√©:', file);
            
            if (!file) return null;
            
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `‚ùå Fichier trop volumineux (Max: 5MB)`;
                return null;
            }
            
            try {
                statusDiv.className = 'status';
                statusDiv.textContent = '‚è≥ Traitement...';

                const fileData = await fileToBase64(file);

                statusDiv.className = 'status success';
                statusDiv.textContent = `‚úÖ ${file.name} - ${Math.round(file.size/1024)}KB`;

                return fileData;
            } catch (error) {
                console.error('‚ùå Erreur handleFileUpload:', error);
                statusDiv.className = 'status error';
                statusDiv.textContent = `‚ùå Erreur: ${error.message}`;
                return null;
            }
        }

        // Event Listeners
        document.getElementById('cin_front').addEventListener('change', async function() {
            console.log('üéØ CIN Front chang√©');
            uploadedFiles.cin_front = await handleFileUpload(this, document.getElementById('cin_front_status'));
            console.log('üìä uploadedFiles.cin_front:', uploadedFiles.cin_front);
            updateDebugInfo();
        });

        document.getElementById('cin_back').addEventListener('change', async function() {
            console.log('üéØ CIN Back chang√©');
            uploadedFiles.cin_back = await handleFileUpload(this, document.getElementById('cin_back_status'));
            console.log('üìä uploadedFiles.cin_back:', uploadedFiles.cin_back);
            updateDebugInfo();
        });

        // Fonctions debug
        function updateDebugInfo() {
            const debugDiv = document.getElementById('debug_info');
            debugDiv.innerHTML = `
                <h3>√âtat uploadedFiles:</h3>
                <p><strong>CIN Front:</strong> ${uploadedFiles.cin_front ? '‚úÖ ' + uploadedFiles.cin_front.name : '‚ùå Pas de fichier'}</p>
                <p><strong>CIN Back:</strong> ${uploadedFiles.cin_back ? '‚úÖ ' + uploadedFiles.cin_back.name : '‚ùå Pas de fichier'}</p>
                <hr>
                <p><strong>D√©tails JSON:</strong></p>
                <pre>${JSON.stringify(uploadedFiles, null, 2)}</pre>
            `;
        }

        function showDebugInfo() {
            console.log('üîç Debug uploadedFiles:', uploadedFiles);
            alert(`CIN Front: ${uploadedFiles.cin_front ? 'OK' : 'MANQUANT'}\nCIN Back: ${uploadedFiles.cin_back ? 'OK' : 'MANQUANT'}`);
            updateDebugInfo();
        }

        function testSubmit() {
            console.log('üöÄ Test envoi - uploadedFiles:', uploadedFiles);
            
            const data = {
                nom: 'Test',
                prenom: 'Debug',
                email: 'test@debug.com',
                raison_sociale: 'Test SARL',
                cin_front: uploadedFiles.cin_front,
                cin_back: uploadedFiles.cin_back,
                cabinet_name: CONFIG.CABINET_NAME,
                gestionnaire_nom: CONFIG.GESTIONNAIRE_NOM,
                gestionnaire_email: CONFIG.GESTIONNAIRE_EMAIL
            };
            
            console.log('üì§ Donn√©es √† envoyer:', data);
            alert(`Pr√™t √† envoyer:\n- CIN Front: ${data.cin_front ? 'OK' : 'MANQUANT'}\n- CIN Back: ${data.cin_back ? 'OK' : 'MANQUANT'}`);
            
            // Ici on pourrait envoyer √† n8n si tout est OK
            // fetch(CONFIG.WEBHOOK_URL, { method: 'POST', ... })
        }

        // Formulaire test
        document.getElementById('testForm').addEventListener('submit', function(e) {
            e.preventDefault();
            testSubmit();
        });

        console.log('üéØ Debug script charg√©. Uploadez des fichiers pour tester.');
    </script>
</body>
</html>
